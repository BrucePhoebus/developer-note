# 前端性能监控

## 认识前端性能监控

#### 前端性能监控体系的流程大体

1. 前端统计->嵌入和非嵌入的。（js收集或工具，插件监控）

2. 真实环境的统计信息 vs 多点的定时监控 （手机用户log或全国机房定时收集性能数据）

3. 后端日志数据可视化。

> 具体还是看业务需求场景和成本考虑，简单的搭建一个简易的监控系统硬件成本就是一台Apache或者Nginx

#### 三步走

###### 第一步：收集

1. 定时使用不同网络环境不同地区的机器，用浏览器或者一些模拟浏览器的工具检查监控页面的各项指标，再保存日志。

	优点，性能指标准确，缺点，样本太少

2. js前端收集用户性能指标（需要阙值，否则无用数据太多）

	优点，样本足够丰富而且是真实用户数据，缺点，性能指标不准确，一些指标或者根本无法收集，比如DNS时间，比如首屏准确时间，最多拿到一个估算值

**我们如何测试用户客户端的网速和首屏时间？**

1. 首屏时间等于head的加载时间，或者说再对页面的所有image进行监控，算出占位是否在首屏线以上，再用图片onload时间作为首屏时间。如果是使用浏览器api或者模拟浏览器的话，可以根据浏览器首屏几个区域的渲染结果当首屏时间来收集，这是最准的。

2. 网速，使用前端js收集用户网速，一般都是ajax下载个已知大小文件，然后算网速，很多测速网站都是这种做法，对页面损耗太大了。

	* 推荐一种做法是，[daniellmb/downlinkMax · GitHub](https://link.zhihu.com/?target=https%3A//github.com/daniellmb/downlinkmax) 参考`navigator.connection`的用法，再对应转换用户网络情况。
	
	* 还有一种做法是我们一个页面的输出加载时间结束后，会有一个document ready的事件，这个时候我们认为整个html文档已经下载完毕了，之后我们再用这个经过的时间和html的质量做除法同样可以得到网速，html文档大小/下载总时间 但是这个值说实话也不是特别准。。。

###### 第二步：日志分析和转换

	日志收集上来之后在apache或者nginx日志中是需要经过2次过滤的，一次是找出标记的比如一个gif图的所有日志，之后再根据你的日志规则，找出你的性能相关日志，之后再转换成方便可读的源数据，比如json格式的。

###### 第三步：求稳定均值，然后数据可视化

	所有性能数据拿到之后，我们需要找到一个可以衡量性能的综合值，就比如说拿页面loaded的时间来说，可能有些用户网速极差，有些用户网速又好，导致数据大了之后，曲线非常不稳定，这个时候我们就需要采用一些方法对性能数据进行降噪，方法也比较简单，设置一个阙值，把非常快和非常慢的数据排除，再求一个均值，这个均值应该就是你最后可视化时需要的一个性能指标了。最后，对数据进行可视化，最好做个web平台界面，可以对数据分段可视化

#### 问题驱动

###### 监控了哪些性能的指标？

	PV，UV，网络查询时间（延迟），白屏时间，可交互时间，页面js异常监控，用户行为统计

###### 如何去监控这些指标？

1. PV，UV，网络查询时间（延迟）：一般通过web服务器的log文件分析

2. 白屏时间：写在页面最顶部，开始计时的js代码，到开始渲染之间的时间差

3. 可交互时间：监听页面的ready事件

4. 页面js异常监控：监控window.error 如果用了前端工程化工具，可以给代码段添加try...catch...捕获

5. 用户行为统计：用户点击某个按钮或类似行为的统计，可以知道网站那个地方比较有吸引力

###### 这些指标的阈值应该是多少？

1. 每个业务形态都不尽相同，不可能有统一的阈值，特别是配置短信/邮件报警的时候。

2. 当用户网络差异大的时候(特别是移动端)，平均数其实没什么用，也就看个概况，中位数也同理。比较好的方式还是做堆叠图，方便看分布。

3. 同比环比，报警功能。。。

> 可参考书：[七天打造性能监控系统](https://link.zhihu.com/?target=http%3A//r.m.baidu.com/u28yb9b)

> [你是如何搭建 Web 前端性能监控系统的？-小爝](https://www.zhihu.com/question/37585246/answer/72801253)
