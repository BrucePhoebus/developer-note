<!--
 * @Description: 
 * @Date: 2019-08-12 17:25:55
 * @LastEditors: phoebus
 * @LastEditTime: 2019-08-13 17:16:53
 -->
# 前端文件上传和下载方案

## 文件上传方案

## 文件下载方案

#### 使用blob下载文件

1. 创建blob响应类型的axios对象

``` js
// axios请求获取blob文件
const blobAxios = axios.create({
    responseType: 'blob',
    timeout: 5 * 60 * 1000,
    paramsSerializer(p) {
        return Qs.stringify(p, {
            indices: false
        });
    }
});

// 用于增加token鉴权，对于开放文件无需设置
blobAxios.interceptors.request.use((config) => {
    const token = authToken.token;
    if (token) {
        config.headers.Authorization = token;
    }
    return config;
});
```

2. 使用blobAxios请求文件信息

``` js
async function exportBusinessReport(url) {
	const response = await blobAxios.get(url);
	return downloadResponse(response);
}
```

3. 生成a标签实现真正的下载

``` js
function downloadFile(url, filename) {
    const link = document.createElement('a');
    link.href = url;
    link.setAttribute('download', filename);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
//获得文件名
function getFileName(response, defaultName = 'file') {
    const disposition = response.headers['content-disposition'];
    const matchGroup = /filename="?([^"^;]+)"?/.exec(decodeURIComponent(disposition));
    if (_.isArray(matchGroup)) {
        return matchGroup[1];
    }

    return defaultName;
}

function downloadResponse(response, exportFileName) {
    const url = window.URL.createObjectURL(new Blob([response.data]));
    const filename = exportFileName || getFileName(response);
    const notAllowedFileType = 'application/json';
    if (response.data.type !== notAllowedFileType) {
        downloadFile(url, filename);
    } else {
        throw new StandardError({
            message: '加载异常，请联系开发查看原因'
        });
    }
}
```

