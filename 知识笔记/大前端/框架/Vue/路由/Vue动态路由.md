<!--
 * @Description: 深入浅出Vue动态路由
 * @Date: 2019-08-10 01:46:28
 * @LastEditors: phoebus
 * @LastEditTime: 2019-08-12 13:52:27
 -->
# Vue动态路由

## 概述

#### 什么是动态路由addRoutes？

* 首先我们先说说一些场景

	* 以前我们虽然用户权限分级不多，但是不同的用户总有一些路由是不需要的，如果我们全部加载的话明显是浪费的

	* 我们有100个路由，但是大部分权限的用户只拥有几十个，而且不同权限的用户拥有的路由还不一样，这样如果我们要在前端写死，我们将要做很多逻辑处理，并且特难维护

	> 其实这一场景就包含了很多问题，一是路由多，二是权限多，这样不同用户对应的路由方案就有很多种，而最简单也是我们最想要的就是，什么权限的用户加载什么路由，这是最优方案

* 以前我们的解决方案比较麻烦，但是有了`addRoutes`之后，一切都简单了，因为`addRoutes`就是动态路由，也就是我们只需要写死很少一部分的路由，剩下变动的路由我们根据用户权限加载进来，然后使用`addRoutes`这个方法加上去

> 当然这也实现是要在项目路由初始化前，也就是路由钩子`beforeEach`中实现，也就是`固定的路由`拼接`权限路由`

#### 简单使用和注意事项

``` js
let router = [
  {
    path: '/foo', component: (resolve) => require(['@/views/addRoutes/foo.vue'], resolve), name: 'foo', description: '这是addRoutes出来的foo页面'
  },
  {
    path: '*', component: (resolve) => require(['@/views/addRoutes/404.vue'], resolve), name: '404', description: '这是addRoutes出来的404页面'
  }
]
// addRoutes
this.$router.addRoutes(router)
```

> `addRoutes`使用很简单，直接将新路由添加到之前的固定路由对象中，之后路由挂载到Vue实例上去时，就是个完整的路由实例

> 注意：动态路由有些规则，主要是添加新的动态路由的数据类型必须是数组，其次符合route对象结构；其次，通过 addRoutes合并的路由不会被`this.$router.options.routes`获取到，所以需要将获取的路由拼接到`this.$router.options.routes`上


#### 实现思路

* 首先先进行用户登录，因为用户登录后我们才知道用户的权限，登录成功的同时，后端会把该用户的权限和拥有的路由一起返回

* 前端收到数据后，把权限数据保存在Vuex中，持久化数据，然后将这些权限路由数据通过动态路由`addRoutes`方法添加到路由实例中，最后会挂载到Vue实例上去

#### 动态路由原理与用途	

* 从作用上看，动态路由其实就是使用方法将路由对象添加到原有实例中，然后刷新路由，实现全局路由更新

* 而参考`vue-router原理`从`设置路由到视图更新的过程`可以看出，存在监听

> [vue-router原理](知识笔记/大前端/框架/Vue/路由/vue-router原理.md)

## 问题与解决

#### 刷新页面路由丢失

* 因为路由是动态获取加载的，也就是每次刷新我们就要重新获取，否则就没了，所以我们要把这些动态路由数据保存起来，一般Vue是用Vuex保存，当然还有其它方案(例如缓存等)，但是使用Vuex保存最简单也最直接，每次检查一下数据还在不，本地有木有，如果路由没了但本地还有(页面刷新了)，就重新`addRoute`配置一下

* 至于在哪里判断？也就是在哪里重新配置路由？可以选择`app.vue`，因为每次刷新都会执行这个页面

> 参考：[addRoutes爬坑记](https://segmentfault.com/a/1190000014545439) | [Vue中后台鉴权的另一种思路 - 动态路由的实现与优化](https://juejin.im/post/5caeb3756fb9a068967791b3)
