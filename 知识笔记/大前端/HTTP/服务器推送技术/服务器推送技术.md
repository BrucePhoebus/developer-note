# 服务器推送技术

## 认识服务器推送技术

#### 传统模式Web系统存在问题

	传统模式的 Web 系统以客户端发出请求、服务器端响应的方式工作

* 这种方式并不能满足很多现实应用的需求

	* 监控系统：后台硬件热插拔、LED、温度、电压发生变化；

	* 即时通信系统：其它用户登录、发送信息；

	* 即时报价系统：后台数据库内容发生变化；

> 这些应用都需要服务器能实时地将更新的信息传送到客户端，而无须客户端发出请求。

#### 各种解决传统模式Web系统问题的方案

###### 客户端轮询

	客户端的页面不断的进行ajax请求，应该很好实现吧。js定时器就可以实现，每次请求如果服务器端有更新数据则响应到客户端。

**存在问题**

	但是这会造成服务器的严重压力，如果在线用户数量过多的话，每隔个一两秒请求一次，哪个服务器能受得了，这种肯定不太现实，或者是最无奈的实现方法，存在严重性能问题。

###### comet技术

	comet技术是服务器推技术的一个总称
	Comet被称为"基于HTTP长连接的服务器推技术"，但不是具体实现方式。

1. 长轮询（long-polling)方式

	它同样使用的ajax,简单说一下，就是客户端使用ajax发送一个请求，HTTP的连接保持，服务器端会 阻塞请求，直到服务器端有一个事件触发或者到达超时。服务器端肯定会开启一个线程，这个线程会时时监测要请求的数据是否有变化，如果有变化，则向客户端输出最新消息，并关闭链接，客户端收到消息处理之后，再次向服务器端请求，如此循环，所以叫长轮询

> 这种实现方式比起客户端不断轮询请求自然要好的多了，不需要客户端不断的ajax请求，减轻服务器端的一定压力，而且可以算得上是实时的。因为这种方案基于 AJAX，请求异步发出，无须安装插件，IE、Mozilla FireFox 都支持。

2. 流方式(长连接)

	流方式是在客户端请求服务端并建立链接之后，服务器端始终不会关闭链接（直到超时，断电或者其他特殊情况）每次有数据时，就向客户端进行输出，而不像长轮询每次向客户端输出之后，都要关闭链接。

> 这种方式的另一个优点是可以大大减少发送到服务器的请求，从而避免了与设置服务器连接相关的开销和延时。

!> 不幸的是，XMLHttpRequest 在不同的浏览器中有很多不同的实现。对于低版本浏览器，尤其是IE仍需使用长轮询。

**过程**

	在长轮询方式下，客户端是在 XMLHttpRequest 的 readystate 为 4（即数据传输结束）时调用回调函数，进行信息处理。当 readystate 为 4 时，数据传输结束，连接已经关闭。Mozilla Firefox 提供了对流方式的支持，即readystate 为 3 时（数据仍在传输中），客户端可以读取数据，从而无须关闭连接，就能读取处理服务器端返回的信息。IE 在 readystate 为 3 时，不能读取服务器返回的数据，目前 IE 不支持流方式。

**问题**

* 长轮询和流都有一个很大的问题

	请求需要在服务器上存在一段较长的时间。这打破了每个请求使用一个线程的模型，因为用于一个请求的线程一直没有被释放。更糟糕的是，除非要发回数据，否则该线程一直处于空闲状态。这显然不具有可伸缩性。当然，存在解决方案

**解决方案**

* 为了有效地处理 Comet，需要非阻塞 IO，Java 通过它的 NIO 库提供非阻塞 IO。两种最流行的开源服务器 Apache Tomcat 和 Jetty 都利用 NIO 增加非阻塞 IO，从而支持 Comet。

	* 阻塞IO:当一个线程调用read() 或 write()时，该线程被阻塞，直到有一些数据被读取，或数据完全写入。该线程在此期间不能再干任何事情了。 

	* Java NIO的非阻塞模式：使一个线程从某通道发送请求读取数据，但是它仅能得到目前可用的数据，如果目前没有数据可用时，就什么都不会获取。而不是保持线程阻塞，所以直至数据变的可以读取之前，该线程可以继续做其他的事情。 

#### 服务器推送技术基础思想

	将浏览器主动查询信息改为服务器主动发送信息。服务器发送一批数据，浏览器显示这些数据，同时保证与服务器的连接。当服务器需要再次发送一批数据时，浏览器显示数据并保持连接。以后，服务器仍然可以发送批量数据，浏览器继续显示数据，依次类推

#### 现在有哪些服务器推送技术？

1. WebSocket

> [认识WebSocket](知识笔记/大前端/HTTP/服务器推送技术/认识WebSocket.md)

> 参考：[java web 服务器推送技术--comet4j](https://blog.csdn.net/hla199106/article/details/46928489 )
